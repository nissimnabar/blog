name: Heal lockfile & verify

on:
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  heal:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Pin EXACT toolchain (match your build job!)
      - uses: actions/setup-node@v4
        with:
          # Prefer this if you have .nvmrc in repo:
          # node-version-file: '.nvmrc'
          node-version: '20.14.0'
          cache: 'npm'

      - name: Show Node/npm versions
        run: |
          node -v
          npm -v

      - name: Show workspaces/overrides & check for stray locks
        run: |
          echo "workspaces:"
          node -e "try{console.log(JSON.stringify(require('./package.json').workspaces||null,null,2))}catch(e){console.log('none')}"
          echo "overrides:"
          node -e "try{console.log(JSON.stringify(require('./package.json').overrides||null,null,2))}catch(e){console.log('none')}"
          echo "stray lockfiles:"
          git ls-files | egrep '(^|/)(package-lock\.json|yarn\.lock|pnpm-lock\.yaml)$' || true

      - name: Minimal lock-only refresh (workspace aware)
        id: lockonly
        continue-on-error: true
        run: |
          if node -e "process.exit(+(!!(require('./package.json').workspaces)))"; then
            npm install --package-lock-only -ws
          else
            npm install --package-lock-only
          fi

      - name: Who requires picomatch (after lock-only)
        run: npm ls picomatch --all || true

      - name: Validate with npm ci --dry-run
        id: dryrun
        continue-on-error: true
        run: npm ci --dry-run

      # Fallback: nuke lock & node_modules, do a FULL re-resolve
      - name: Full re-resolve (if dry-run failed)
        if: steps.dryrun.outcome == 'failure'
        run: |
          rm -f package-lock.json
          rm -rf node_modules
          if node -e "process.exit(+(!!(require('./package.json').workspaces)))"; then
            npm install -ws
          else
            npm install
          fi
          echo "Post full resolve lockfileVersion:"
          node -e "const f=require('./package-lock.json'); console.log('lockfileVersion:', f.lockfileVersion)"
          echo "Picomatch tree after full resolve:"
          npm ls picomatch --all || true
          echo "Re-validate:"
          npm ci --dry-run

      - name: Commit regenerated lockfile
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: heal package-lock.json (workspace-aware, Node pinned)"
          file_pattern: package-lock.json
          branch: lockfile/heal
          create_branch: true

      - name: Open PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: lockfile/heal
          title: "Heal package-lock.json"
          body: |
            - Regenerated lockfile (workspace-aware)
            - Pinned Node/npm to match build
            - Validated with `npm ci --dry-run`
          base: ${{ github.ref_name }}
